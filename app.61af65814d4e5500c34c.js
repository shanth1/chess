(()=>{"use strict";var e={972:(e,t,n)=>{n.r(t),n.d(t,{peerConfiguration:()=>s});const s={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478"},{urls:"stun:stun.services.mozilla.com"},{urls:"stun:stun.nextcloud.com:443"},{urls:"stun:numb.viagenie.ca"},{urls:"stun:stun.voip.blackberry.com:3478"},{urls:"stun:stun.voipbuster.com"},{urls:"stun:stun.voxgratia.org"},{urls:"stun:freestun.net:3479"},{urls:"stun:iphone-stun.strato-iphone.de:3478"},{urls:"stun:numb.viagenie.ca:3478"},{urls:"stun:s1.taraba.net:3478"},{urls:"stun:s2.taraba.net:3478"},{urls:"stun:stun.12connect.com:3478"},{urls:"stun:stun.12voip.com:3478"},{urls:"stun:stun.1und1.de:3478"},{urls:"stun:stun.2talk.co.nz:3478"},{urls:"stun:stun.2talk.com:3478"},{urls:"stun:stun.3clogic.com:3478"},{urls:"stun:stun.3cx.com:3478"},{urls:"stun:stun.a-mm.tv:3478"},{urls:"stun:stun.aa.net.uk:3478"},{urls:"stun:stun.acrobits.cz:3478"},{urls:"stun:stun.actionvoip.com:3478"},{urls:"stun:stun.advfn.com:3478"},{urls:"stun:stun.aeta-audio.com:3478"},{urls:"stun:stun.aeta.com:3478"},{urls:"stun:stun.alltel.com.au:3478"},{urls:"stun:stun.altar.com.pl:3478"},{urls:"stun:stun.annatel.net:3478"},{urls:"stun:stun.antisip.com:3478"},{urls:"stun:stun.arbuz.ru:3478"},{urls:"stun:stun.avigora.com:3478"},{urls:"stun:stun.avigora.fr:3478"},{urls:"stun:stun.awa-shima.com:3478"},{urls:"stun:stun.awt.be:3478"},{urls:"stun:stun.b2b2c.ca:3478"}]}}},t={};function n(s){var r=t[s];if(void 0!==r)return r.exports;var i=t[s]={exports:{}};return e[s](i,i.exports,n),i.exports}n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{const e=class{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._element=document.createElement(e);for(const[e,n]of Object.entries(t))this._element.setAttribute(e,n)}get element(){return this._element}subscribe(e,t){e.subscribe(t),t()}},t=class extends e{constructor(e){super("div"),this._element.innerText=e,this._element.classList.add("header")}updateText(e){this._element.innerText=e}},s=class extends e{constructor(e,t){super("button"),this._element.innerText=e,this._element.classList.add("button"),this._element.onclick=t}},r=class extends e{constructor(){super("input"),this._element.classList.add("X6UxfUUG")}},i=new class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"page";!(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&console.log("url routing is not available now"),this.pageId=e,window.addEventListener("hashchange",(e=>{this._resolve()})),window.addEventListener("DOMContentLoaded",(()=>{this._resolve()}))}initRoutes(e){this._routes=e}initPageContainer(e){this._pageContainer=e,this._pageContainer.id="page-container"}_activeClassResolver(e,t){window.addEventListener(e,(()=>{""===location.hash?t("#"):t(location.hash)}))}updateActiveClass(e){this._activeClassResolver("hashchange",e),this._activeClassResolver("DOMContentLoaded",e)}navigate(e){location.hash=e}isActive(e){return!location.hash&&"#"===e||location.hash===e}_updatePage(e){this._pageContainer.innerHTML="",this._pageContainer.appendChild(e)}_resolve(){if(""===location.hash){const e=this._routes["/"];return void(e&&this._updatePage(e()))}const e=this._routes[location.hash.replace("#","/")];e?this._updatePage(e()):this._pageContainer.innerHTML="404 | Not Found"}},{peerConfiguration:o}=n(972),a=new class{constructor(e){this.peerConfiguration=e}initPeerConnection(){const e=JSON.parse(localStorage.getItem("chess-state"));e?.connection&&this.peerConfiguration.iceServers.push(...e.connection.turn),this.peer=new RTCPeerConnection(this.peerConfiguration)}initLogger(e){const t=(t,n)=>{const s=document.createElement("div");switch(s.style.paddingBottom="5px",n){case"ok":t&&(s.style.color="green");break;case"error":s.style.color="red";break;case"state":s.style.color="orange"}s.innerText=t,e.prepend(s)};this.peer.onconnectionstatechange=e=>{const n=`[state changed]: ${this.peer.iceConnectionState}`;t(n,"state")},this.peer.onicecandidateerror=e=>{t(e.type,"error")},this.peer.onicecandidate=e=>{const n=e.candidate?.candidate;t(n,"ok")}}getLocalDescription(){return JSON.stringify(this.peer.localDescription)}onIceCandidate(e){this.peer.addEventListener("icecandidate",(()=>{e()}))}setRemoteDescription(e){this.peer.setRemoteDescription(JSON.parse(e))}async createOffer(){try{const e=await this.peer.createOffer();this.peer.setLocalDescription(e)}catch(e){console.error(e)}}async createAnswer(){try{const e=await this.peer.createAnswer();this.peer.setLocalDescription(e)}catch(e){console.error(e)}}onOpen(e,t){switch(e){case"alice":this.peer.ondatachannel=e=>{console.log("on data channel",e),this.dataChannel=e.channel,this.dataChannel.onopen=t};break;case"bob":this.dataChannel=this.peer.createDataChannel("channel-name"),this.dataChannel.onopen=t;break;default:console.error("unknown role")}}}(o),l="FETCH_ERROR",c="SET_TURN_SERVERS",h="DELETE_TURN_SERVERS",u="SET_ORIENTATION",d="chess-state",p=new class{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._reducers=e,this._middlewares=t,this._isLocalStorageConnected=n;const s=JSON.parse(localStorage.getItem(d));this._isLocalStorageConnected&&s?this._state=s:this._state=this._reduce(),this._listeners=[],this._initMiddlewares()}_initMiddlewares(){var e=this;const t={getState:this.getState.bind(this),dispatch:function(t){for(var n=arguments.length,s=new Array(n>1?n-1:0),r=1;r<n;r++)s[r-1]=arguments[r];return e.dispatch(t,...s)}},n=this._middlewares.map((e=>e(t)));this.dispatch=n.reduce(((e,t)=>t(e)),this.dispatch.bind(this))}_reduce(e,t){return Object.keys(this._reducers).reduce(((n,s)=>(n[s]=this._reducers[s](e&&e[s],t),n)),{})}getState(){return this._state}dispatch(e){this._state=this._reduce(this._state,e),this._isLocalStorageConnected&&localStorage.setItem(d,JSON.stringify(this._state)),this._listeners.forEach((e=>e()))}subscribe(e){return this._listeners.push(e),()=>{this._listeners=this._listeners.filter((t=>t!==e))}}}({profile:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{username:"user",avatar:""},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"SET_USERNAME"===t.type?{...e,text:t.payload.username}:e},connection:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{stun:[],turn:[],error:""},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(t.type){case c:return{...e,turn:t.payload.data};case h:return{...e,turn:[]};case l:return{...e,error:t.payload.error};default:return e}},game:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{orientation:""},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.type===u?{...e,orientation:t.payload.orientation}:e}},[e=>t=>n=>{n.isFetch?fetch(n.payload.url).then((e=>e.json())).then((e=>(console.log("success response:",e),(async e=>{if(!Array.isArray(e))return Promise.reject(new Error("Incorrect response"));for(const t of e)if("string"!=typeof t.urls&&!Array.isArray(t.urls))return Promise.reject(new Error("Incorrect urls in iceServers"));try{return new RTCPeerConnection(e),Promise.resolve(e)}catch(e){return Promise.reject(new Error("Connection instantiation console.error();"))}})(e)))).then((t=>{const s={type:n.type,payload:{data:t}};e.dispatch(s)})).catch((t=>{const n="SyntaxError"===t.name?"Fetch error":t.message;e.dispatch({type:l,payload:{error:n}}),setTimeout((()=>{e.dispatch({type:l,payload:{error:""}})}),1500)})):t(n)}]),_=function(n){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const r=new e("div").element;r.classList.add("j2362cLf");const i=new t(n);return r.appendChild(i.element),s.forEach((e=>r.appendChild(e))),r},g="w",f="b",m="p",v="b",b="r",C="q",E="k",S="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",y=-1,k={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},w={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},T={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},A={b:[16,32,17,15],w:[-16,-32,-17,-15]},I={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},L=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],R=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],N={p:1,n:2,b:4,r:8,q:16,k:32},P=["n",v,b,C],x={[E]:w.KSIDE_CASTLE,[C]:w.QSIDE_CASTLE},O={w:[{square:T.a1,flag:w.QSIDE_CASTLE},{square:T.h1,flag:w.KSIDE_CASTLE}],b:[{square:T.a8,flag:w.QSIDE_CASTLE},{square:T.h8,flag:w.KSIDE_CASTLE}]},D={b:1,w:6},q=["1-0","0-1","1/2-1/2","*"];function M(e){return e>>4}function U(e){return 15&e}function K(e){return-1!=="0123456789".indexOf(e)}function F(e){const t=U(e),n=M(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(n,n+1)}function Q(e){return e===g?f:g}function j(e,t,n,s,r,i=void 0,o=w.NORMAL){const a=M(s);if(r!==m||7!==a&&0!==a)e.push({color:t,from:n,to:s,piece:r,captured:i,flags:o});else for(let a=0;a<P.length;a++){const l=P[a];e.push({color:t,from:n,to:s,piece:r,captured:i,promotion:l,flags:o|w.PROMOTION})}}function $(e){let t=e.charAt(0);if(t>="a"&&t<="h"){if(e.match(/[a-h]\d.*[a-h]\d/))return;return m}return t=t.toLowerCase(),"o"===t?E:t}function B(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function W(e){return e.split(" ").slice(0,4).join(" ")}class z{_board=new Array(128);_turn=g;_header={};_kings={w:y,b:y};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_positionCounts={};constructor(e=S){this.load(e)}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:y,b:y},this._turn=g,this._castling={w:0,b:0},this._epSquare=y,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{},delete this._header.SetUp,delete this._header.FEN,this._positionCounts=new Proxy({},{get:(e,t)=>"length"===t?Object.keys(e).length:e?.[W(t)]||0,set:(e,t,n)=>{const s=W(t);return 0===n?delete e[s]:e[s]=n,!0}})}removeHeader(e){e in this._header&&delete this._header[e]}load(e,{skipValidation:t=!1,preserveHeaders:n=!1}={}){let s=e.split(/\s+/);if(s.length>=2&&s.length<6){const t=["-","-","0","1"];e=s.concat(t.slice(-(6-s.length))).join(" ")}if(s=e.split(/\s+/),!t){const{ok:t,error:n}=function(e){const t=e.split(/\s+/);if(6!==t.length)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const n=parseInt(t[5],10);if(isNaN(n)||n<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const r=t[0].split("/");if(8!==r.length)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let e=0;e<r.length;e++){let t=0,n=!1;for(let s=0;s<r[e].length;s++)if(K(r[e][s])){if(n)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};t+=parseInt(r[e][s],10),n=!0}else{if(!/^[prnbqkPRNBQK]$/.test(r[e][s]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};t+=1,n=!1}if(8!==t)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if("3"==t[3][1]&&"w"==t[1]||"6"==t[3][1]&&"b"==t[1])return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const i=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:e,regex:n}of i){if(!n.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${e} king`};if((t[0].match(n)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${e} kings`}}return Array.from(r[0]+r[7]).some((e=>"P"===e.toUpperCase()))?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}(e);if(!t)throw new Error(n)}const r=s[0];let i=0;this.clear({preserveHeaders:n});for(let e=0;e<r.length;e++){const t=r.charAt(e);if("/"===t)i+=8;else if(K(t))i+=parseInt(t,10);else{const e=t<"a"?g:f;this._put({type:t.toLowerCase(),color:e},F(i)),i++}}this._turn=s[1],s[2].indexOf("K")>-1&&(this._castling.w|=w.KSIDE_CASTLE),s[2].indexOf("Q")>-1&&(this._castling.w|=w.QSIDE_CASTLE),s[2].indexOf("k")>-1&&(this._castling.b|=w.KSIDE_CASTLE),s[2].indexOf("q")>-1&&(this._castling.b|=w.QSIDE_CASTLE),this._epSquare="-"===s[3]?y:T[s[3]],this._halfMoves=parseInt(s[4],10),this._moveNumber=parseInt(s[5],10),this._updateSetup(e),this._positionCounts[e]++}fen(){let e=0,t="";for(let n=T.a8;n<=T.h1;n++){if(this._board[n]){e>0&&(t+=e,e=0);const{color:s,type:r}=this._board[n];t+=s===g?r.toUpperCase():r.toLowerCase()}else e++;n+1&136&&(e>0&&(t+=e),n!==T.h1&&(t+="/"),e=0,n+=8)}let n="";this._castling[g]&w.KSIDE_CASTLE&&(n+="K"),this._castling[g]&w.QSIDE_CASTLE&&(n+="Q"),this._castling[f]&w.KSIDE_CASTLE&&(n+="k"),this._castling[f]&w.QSIDE_CASTLE&&(n+="q"),n=n||"-";let s="-";if(this._epSquare!==y){const e=this._epSquare+(this._turn===g?16:-16),t=[e+1,e-1];for(const e of t){if(136&e)continue;const t=this._turn;if(this._board[e]?.color===t&&this._board[e]?.type===m){this._makeMove({color:t,from:e,to:this._epSquare,piece:m,captured:m,flags:w.EP_CAPTURE});const n=!this._isKingAttacked(t);if(this._undoMove(),n){s=F(this._epSquare);break}}}}return[t,this._turn,n,s,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==S?(this._header.SetUp="1",this._header.FEN=e):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(S)}get(e){return this._board[T[e]]||!1}put({type:e,color:t},n){return!!this._put({type:e,color:t},n)&&(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0)}_put({type:e,color:t},n){if(-1==="pnbrqkPNBRQK".indexOf(e.toLowerCase()))return!1;if(!(n in T))return!1;const s=T[n];if(e==E&&this._kings[t]!=y&&this._kings[t]!=s)return!1;const r=this._board[s];return r&&r.type===E&&(this._kings[r.color]=y),this._board[s]={type:e,color:t},e===E&&(this._kings[t]=s),!0}remove(e){const t=this.get(e);return delete this._board[T[e]],t&&t.type===E&&(this._kings[t.color]=y),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){const e=this._board[T.e1]?.type===E&&this._board[T.e1]?.color===g,t=this._board[T.e8]?.type===E&&this._board[T.e8]?.color===f;e&&this._board[T.a1]?.type===b&&this._board[T.a1]?.color===g||(this._castling.w&=~w.QSIDE_CASTLE),e&&this._board[T.h1]?.type===b&&this._board[T.h1]?.color===g||(this._castling.w&=~w.KSIDE_CASTLE),t&&this._board[T.a8]?.type===b&&this._board[T.a8]?.color===f||(this._castling.b&=~w.QSIDE_CASTLE),t&&this._board[T.h8]?.type===b&&this._board[T.h8]?.color===f||(this._castling.b&=~w.KSIDE_CASTLE)}_updateEnPassantSquare(){if(this._epSquare===y)return;const e=this._epSquare+(this._turn===g?-16:16),t=this._epSquare+(this._turn===g?16:-16),n=[t+1,t-1];null===this._board[e]&&null===this._board[this._epSquare]&&this._board[t]?.color===Q(this._turn)&&this._board[t]?.type===m&&n.some((e=>!(136&e)&&this._board[e]?.color===this._turn&&this._board[e]?.type===m))||(this._epSquare=y)}_attacked(e,t){for(let n=T.a8;n<=T.h1;n++){if(136&n){n+=7;continue}if(void 0===this._board[n]||this._board[n].color!==e)continue;const s=this._board[n],r=n-t;if(0===r)continue;const i=r+119;if(L[i]&N[s.type]){if(s.type===m){if(r>0){if(s.color===g)return!0}else if(s.color===f)return!0;continue}if("n"===s.type||"k"===s.type)return!0;const e=R[i];let o=n+e,a=!1;for(;o!==t;){if(null!=this._board[o]){a=!0;break}o+=e}if(!a)return!0}}return!1}_isKingAttacked(e){const t=this._kings[e];return-1!==t&&this._attacked(Q(e),t)}isAttacked(e,t){return this._attacked(t,T[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&0===this._moves().length}isStalemate(){return!this.isCheck()&&0===this._moves().length}isInsufficientMaterial(){const e={b:0,n:0,r:0,q:0,k:0,p:0},t=[];let n=0,s=0;for(let r=T.a8;r<=T.h1;r++){if(s=(s+1)%2,136&r){r+=7;continue}const i=this._board[r];i&&(e[i.type]=i.type in e?e[i.type]+1:1,i.type===v&&t.push(s),n++)}if(2===n)return!0;if(3===n&&(1===e[v]||1===e.n))return!0;if(n===e[v]+2){let e=0;const n=t.length;for(let s=0;s<n;s++)e+=t[s];if(0===e||e===n)return!0}return!1}_getRepetitionCount(){return this._positionCounts[this.fen()]}isThreefoldRepetition(){return this._getRepetitionCount()>=3}isDraw(){return this._halfMoves>=100||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:t,piece:n}={}){const s=this._moves({square:t,piece:n});return e?s.map((e=>this._makePretty(e))):s.map((e=>this._moveToSan(e,s)))}_moves({legal:e=!0,piece:t,square:n}={}){const s=n?n.toLowerCase():void 0,r=t?.toLowerCase(),i=[],o=this._turn,a=Q(o);let l=T.a8,c=T.h1,h=!1;if(s){if(!(s in T))return[];l=c=T[s],h=!0}for(let e=l;e<=c;e++){if(136&e){e+=7;continue}if(!this._board[e]||this._board[e].color===a)continue;const{type:t}=this._board[e];let n;if(t===m){if(r&&r!==t)continue;n=e+A[o][0],this._board[n]||(j(i,o,e,n,m),n=e+A[o][1],D[o]!==M(e)||this._board[n]||j(i,o,e,n,m,void 0,w.BIG_PAWN));for(let t=2;t<4;t++)n=e+A[o][t],136&n||(this._board[n]?.color===a?j(i,o,e,n,m,this._board[n].type,w.CAPTURE):n===this._epSquare&&j(i,o,e,n,m,m,w.EP_CAPTURE))}else{if(r&&r!==t)continue;for(let s=0,r=I[t].length;s<r;s++){const r=I[t][s];for(n=e;n+=r,!(136&n);){if(this._board[n]){if(this._board[n].color===o)break;j(i,o,e,n,t,this._board[n].type,w.CAPTURE);break}if(j(i,o,e,n,t),"n"===t||t===E)break}}}}if(!(void 0!==r&&r!==E||h&&c!==this._kings[o])){if(this._castling[o]&w.KSIDE_CASTLE){const e=this._kings[o],t=e+2;this._board[e+1]||this._board[t]||this._attacked(a,this._kings[o])||this._attacked(a,e+1)||this._attacked(a,t)||j(i,o,this._kings[o],t,E,void 0,w.KSIDE_CASTLE)}if(this._castling[o]&w.QSIDE_CASTLE){const e=this._kings[o],t=e-2;this._board[e-1]||this._board[e-2]||this._board[e-3]||this._attacked(a,this._kings[o])||this._attacked(a,e-1)||this._attacked(a,t)||j(i,o,this._kings[o],t,E,void 0,w.QSIDE_CASTLE)}}if(!e||-1===this._kings[o])return i;const u=[];for(let e=0,t=i.length;e<t;e++)this._makeMove(i[e]),this._isKingAttacked(o)||u.push(i[e]),this._undoMove();return u}move(e,{strict:t=!1}={}){let n=null;if("string"==typeof e)n=this._moveFromSan(e,t);else if("object"==typeof e){const t=this._moves();for(let s=0,r=t.length;s<r;s++)if(e.from===F(t[s].from)&&e.to===F(t[s].to)&&(!("promotion"in t[s])||e.promotion===t[s].promotion)){n=t[s];break}}if(!n)throw"string"==typeof e?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);const s=this._makePretty(n);return this._makeMove(n),this._positionCounts[s.after]++,s}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){const t=this._turn,n=Q(t);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&w.EP_CAPTURE&&(this._turn===f?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:t}),this._board[e.to].type===E){if(this._kings[t]=e.to,e.flags&w.KSIDE_CASTLE){const t=e.to-1,n=e.to+1;this._board[t]=this._board[n],delete this._board[n]}else if(e.flags&w.QSIDE_CASTLE){const t=e.to+1,n=e.to-2;this._board[t]=this._board[n],delete this._board[n]}this._castling[t]=0}if(this._castling[t])for(let n=0,s=O[t].length;n<s;n++)if(e.from===O[t][n].square&&this._castling[t]&O[t][n].flag){this._castling[t]^=O[t][n].flag;break}if(this._castling[n])for(let t=0,s=O[n].length;t<s;t++)if(e.to===O[n][t].square&&this._castling[n]&O[n][t].flag){this._castling[n]^=O[n][t].flag;break}e.flags&w.BIG_PAWN?this._epSquare=t===f?e.to-16:e.to+16:this._epSquare=y,e.piece===m||e.flags&(w.CAPTURE|w.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===f&&this._moveNumber++,this._turn=n}undo(){const e=this._undoMove();if(e){const t=this._makePretty(e);return this._positionCounts[t.after]--,t}return null}_undoMove(){const e=this._history.pop();if(void 0===e)return null;const t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;const n=this._turn,s=Q(n);if(this._board[t.from]=this._board[t.to],this._board[t.from].type=t.piece,delete this._board[t.to],t.captured)if(t.flags&w.EP_CAPTURE){let e;e=n===f?t.to-16:t.to+16,this._board[e]={type:m,color:s}}else this._board[t.to]={type:t.captured,color:s};if(t.flags&(w.KSIDE_CASTLE|w.QSIDE_CASTLE)){let e,n;t.flags&w.KSIDE_CASTLE?(e=t.to+1,n=t.to-1):(e=t.to-2,n=t.to+1),this._board[e]=this._board[n],delete this._board[n]}return t}pgn({newline:e="\n",maxWidth:t=0}={}){const n=[];let s=!1;for(const t in this._header)n.push("["+t+' "'+this._header[t]+'"]'+e),s=!0;s&&this._history.length&&n.push(e);const r=e=>{const t=this._comments[this.fen()];return void 0!==t&&(e=`${e}${e.length>0?" ":""}{${t}}`),e},i=[];for(;this._history.length>0;)i.push(this._undoMove());const o=[];let a="";for(0===i.length&&o.push(r(""));i.length>0;){a=r(a);const e=i.pop();if(!e)break;if(this._history.length||"b"!==e.color)"w"===e.color&&(a.length&&o.push(a),a=this._moveNumber+".");else{const e=`${this._moveNumber}. ...`;a=a?`${a} ${e}`:e}a=a+" "+this._moveToSan(e,this._moves({legal:!0})),this._makeMove(e)}if(a.length&&o.push(r(a)),void 0!==this._header.Result&&o.push(this._header.Result),0===t)return n.join("")+o.join(" ");const l=function(){return n.length>0&&" "===n[n.length-1]&&(n.pop(),!0)},c=function(s,r){for(const i of r.split(" "))if(i){if(s+i.length>t){for(;l();)s--;n.push(e),s=0}n.push(i),s+=i.length,n.push(" "),s++}return l()&&s--,s};let h=0;for(let s=0;s<o.length;s++)h+o[s].length>t&&o[s].includes("{")?h=c(h,o[s]):(h+o[s].length>t&&0!==s?(" "===n[n.length-1]&&n.pop(),n.push(e),h=0):0!==s&&(n.push(" "),h++),n.push(o[s]),h+=o[s].length);return n.join("")}header(...e){for(let t=0;t<e.length;t+=2)"string"==typeof e[t]&&"string"==typeof e[t+1]&&(this._header[e[t]]=e[t+1]);return this._header}loadPgn(e,{strict:t=!1,newlineChar:n="\r?\n"}={}){function s(e){return e.replace(/\\/g,"\\")}e=e.trim();const r=new RegExp("^(\\[((?:"+s(n)+")|.)*\\])((?:\\s*"+s(n)+"){2}|(?:\\s*"+s(n)+")*$)").exec(e),i=r&&r.length>=2?r[1]:"";this.reset();const o=function(e){const t={},r=e.split(new RegExp(s(n)));let i="",o="";for(let e=0;e<r.length;e++){const n=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;i=r[e].replace(n,"$1"),o=r[e].replace(n,"$2"),i.trim().length>0&&(t[i]=o)}return t}(i);let a="";for(const e in o)"fen"===e.toLowerCase()&&(a=o[e]),this.header(e,o[e]);if(t){if("1"===o.SetUp){if(!("FEN"in o))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(o.FEN,{preserveHeaders:!0})}}else a&&this.load(a,{preserveHeaders:!0});const l=function(e){return`{${function(e){return Array.from(e).map((function(e){return e.charCodeAt(0)<128?e.charCodeAt(0).toString(16):encodeURIComponent(e).replace(/%/g,"").toLowerCase()})).join("")}((e=e.replace(new RegExp(s(n),"g")," ")).slice(1,e.length-1))}}`},c=function(e){if(e.startsWith("{")&&e.endsWith("}"))return function(e){return 0==e.length?"":decodeURIComponent("%"+(e.match(/.{1,2}/g)||[]).join("%"))}(e.slice(1,e.length-1))};let h=e.replace(i,"").replace(new RegExp(`({[^}]*})+?|;([^${s(n)}]*)`,"g"),(function(e,t,n){return void 0!==t?l(t):" "+l(`{${n.slice(1)}}`)})).replace(new RegExp(s(n),"g")," ");const u=/(\([^()]+\))+?/g;for(;u.test(h);)h=h.replace(u,"");h=h.replace(/\d+\.(\.\.)?/g,""),h=h.replace(/\.\.\./g,""),h=h.replace(/\$\d+/g,"");let d=h.trim().split(new RegExp(/\s+/));d=d.filter((e=>""!==e));let p="";for(let e=0;e<d.length;e++){const n=c(d[e]);if(void 0!==n){this._comments[this.fen()]=n;continue}const s=this._moveFromSan(d[e],t);if(null==s){if(!(q.indexOf(d[e])>-1))throw new Error(`Invalid move in PGN: ${d[e]}`);p=d[e]}else p="",this._makeMove(s),this._positionCounts[this.fen()]++}p&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",p)}_moveToSan(e,t){let n="";if(e.flags&w.KSIDE_CASTLE)n="O-O";else if(e.flags&w.QSIDE_CASTLE)n="O-O-O";else{if(e.piece!==m){const s=function(e,t){const n=e.from,s=e.to,r=e.piece;let i=0,o=0,a=0;for(let e=0,l=t.length;e<l;e++){const l=t[e].from,c=t[e].to;r===t[e].piece&&n!==l&&s===c&&(i++,M(n)===M(l)&&o++,U(n)===U(l)&&a++)}return i>0?o>0&&a>0?F(n):a>0?F(n).charAt(1):F(n).charAt(0):""}(e,t);n+=e.piece.toUpperCase()+s}e.flags&(w.CAPTURE|w.EP_CAPTURE)&&(e.piece===m&&(n+=F(e.from)[0]),n+="x"),n+=F(e.to),e.promotion&&(n+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?n+="#":n+="+"),this._undoMove(),n}_moveFromSan(e,t=!1){const n=B(e);let s,r,i,o,a,l=$(n),c=this._moves({legal:!0,piece:l});for(let e=0,t=c.length;e<t;e++)if(n===B(this._moveToSan(c[e],c)))return c[e];if(t)return null;let h=!1;if(r=n.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),r?(s=r[1],i=r[2],o=r[3],a=r[4],1==i.length&&(h=!0)):(r=n.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),r&&(s=r[1],i=r[2],o=r[3],a=r[4],1==i.length&&(h=!0))),l=$(n),c=this._moves({legal:!0,piece:s||l}),!o)return null;for(let e=0,t=c.length;e<t;e++)if(i){if(!(s&&s.toLowerCase()!=c[e].piece||T[i]!=c[e].from||T[o]!=c[e].to||a&&a.toLowerCase()!=c[e].promotion))return c[e];if(h){const t=F(c[e].from);if(!(s&&s.toLowerCase()!=c[e].piece||T[o]!=c[e].to||i!=t[0]&&i!=t[1]||a&&a.toLowerCase()!=c[e].promotion))return c[e]}}else if(n===B(this._moveToSan(c[e],c)).replace("x",""))return c[e];return null}ascii(){let e="   +------------------------+\n";for(let t=T.a8;t<=T.h1;t++){if(0===U(t)&&(e+=" "+"87654321"[M(t)]+" |"),this._board[t]){const n=this._board[t].type;e+=" "+(this._board[t].color===g?n.toUpperCase():n.toLowerCase())+" "}else e+=" . ";t+1&136&&(e+="|\n",t+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h",e}perft(e){const t=this._moves({legal:!1});let n=0;const s=this._turn;for(let r=0,i=t.length;r<i;r++)this._makeMove(t[r]),this._isKingAttacked(s)||(e-1>0?n+=this.perft(e-1):n++),this._undoMove();return n}_makePretty(e){const{color:t,piece:n,from:s,to:r,flags:i,captured:o,promotion:a}=e;let l="";for(const e in w)w[e]&i&&(l+=k[e]);const c=F(s),h=F(r),u={color:t,piece:n,from:c,to:h,san:this._moveToSan(e,this._moves({legal:!0})),flags:l,lan:c+h,before:this.fen(),after:""};return this._makeMove(e),u.after=this.fen(),this._undoMove(),o&&(u.captured=o),a&&(u.promotion=a,u.lan+=a),u}turn(){return this._turn}board(){const e=[];let t=[];for(let n=T.a8;n<=T.h1;n++)null==this._board[n]?t.push(null):t.push({square:F(n),type:this._board[n].type,color:this._board[n].color}),n+1&136&&(e.push(t),t=[],n+=8);return e}squareColor(e){if(e in T){const t=T[e];return(M(t)+U(t))%2==0?"light":"dark"}return null}history({verbose:e=!1}={}){const t=[],n=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){const s=t.pop();if(!s)break;e?n.push(this._makePretty(s)):n.push(this._moveToSan(s,this._moves())),this._makeMove(s)}return n}_pruneComments(){const e=[],t={},n=e=>{e in this._comments&&(t[e]=this._comments[e])};for(;this._history.length>0;)e.push(this._undoMove());for(n(this.fen());;){const t=e.pop();if(!t)break;this._makeMove(t),n(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){const e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map((e=>({fen:e,comment:this._comments[e]})))}deleteComments(){return this._pruneComments(),Object.keys(this._comments).map((e=>{const t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}}))}setCastlingRights(e,t){for(const n of[E,C])void 0!==t[n]&&(t[n]?this._castling[e]|=x[n]:this._castling[e]&=~x[n]);this._updateCastlingRights();const n=this.getCastlingRights(e);return!(void 0!==t[E]&&t[E]!==n[E]||void 0!==t[C]&&t[C]!==n[C])}getCastlingRights(e){return{[E]:0!=(this._castling[e]&x[E]),[C]:0!=(this._castling[e]&x[C])}}moveNumber(){return this._moveNumber}}const H=e=>{const t=document.createElement("div");return t.innerText=`[${(new Date).getHours()}:${(new Date).getMinutes()}] ${e}`,t.style.fontSize="24px",t};window.addEventListener("load",(()=>{(async()=>{if(navigator.serviceWorker)try{const e=await navigator.serviceWorker.register("./sw.js");console.log("SW register success",e)}catch(e){console.error("SW register failed:",e)}})()}));const J=document.getElementById("root");i.initPageContainer(J),i.initRoutes({"/":()=>{const e=document.createElement("div"),t=new s("p2p",(()=>{i.navigate("connect")})).element,n=new s("Engine").element;n.disabled=!0;const r=new s("Offline").element;r.disabled=!0;const o=[t,r,n];return e.appendChild(_("Menu",o)),e},"/alice":()=>{p.dispatch({type:u,payload:{orientation:"black"}});const e=document.createElement("div");e.style.padding="20px";const t=(()=>{const e=document.createElement("div");return e.style.padding="8px",e.style.fontSize="22px",e.innerText="Статус: ожидаем offer",e})(),n=document.createElement("div");a.initPeerConnection(),a.initLogger(n),a.onIceCandidate=()=>{t.innerText="Статус: создан answer"};const r=new s("Paste",(()=>{navigator.clipboard.readText().then((e=>{a.onIceCandidate((()=>t.innerText="Статус: создан answer")),a.setRemoteDescription(e),a.onOpen("alice",(()=>{i.navigate("game")})),a.createAnswer()})).catch(console.error)})).element;r.style.marginRight="8px";const o=new s("Copy",(()=>{const e=a.getLocalDescription();e&&navigator.clipboard.writeText(e).then((()=>{t.innerText="Статус: скопировано, ждем открытия канала"})).catch(console.error)})).element;return e.appendChild(t),e.appendChild(r),e.appendChild(o),e.appendChild(n),e},"/bob":()=>{p.dispatch({type:u,payload:{orientation:"white"}});const e=document.createElement("div");e.style.padding="20px";const t=(()=>{const e=document.createElement("div");return e.style.padding="8px",e.style.fontSize="22px",e.innerText="Статус:",e})(),n=document.createElement("div");a.initPeerConnection(),(e=>{a.onOpen("bob",(()=>{i.navigate("game")})),a.onIceCandidate((()=>{e.innerText="Статус: создан offer"}))})(t),a.initLogger(n),a.createOffer();const r=new s("Copy",(()=>{const e=a.getLocalDescription();e&&navigator.clipboard.writeText(e).then((()=>{t.innerText="Статус: скопировано, ожидаем answer"})).catch(console.error)})).element;r.style.marginRight="8px";const o=new s("Paste",(()=>{navigator.clipboard.readText().then((e=>{a.setRemoteDescription(e)})).catch(console.error)})).element;return e.appendChild(t),e.appendChild(r),e.appendChild(o),e.appendChild(n),e},"/connect":()=>{const t=document.createElement("div"),n=new s("Bob",(()=>{i.navigate("bob")})).element,r=new s("Alice",(()=>{i.navigate("alice")})).element,o=new s("Past TURN",(()=>{navigator.clipboard.readText().then((e=>{p.dispatch({isFetch:!0,type:c,payload:{url:e}})})).catch(console.error)})).element,a=new s("Delete TURN",(()=>{p.dispatch({type:h})})).element,l=new s("←",(()=>{i.navigate("")})).element;l.style.marginTop="20px";const u=[n,r,o,a,l];return t.appendChild(_("Choose the role",u)),t.appendChild((()=>{const t=new e("div");return t.element.style.display="flex",t.element.style.justifyContent="center",t.subscribe(p,(()=>{p.getState()?.connection?.turn.length>0?(t.element.innerText="turn is connected",t.element.style.color="green"):p.getState()?.connection?.error?(t.element.innerText=p.getState().connection.error,t.element.style.color="red"):(t.element.innerText="turn is not connected",t.element.style.color="orange")})),t.element})()),t},"/game":()=>{const e=document.createElement("div"),t=document.createElement("form");t.style.display="flex",t.style.justifyContent="center",t.style.padding="20px",t.onsubmit=e=>e.preventDefault();const n=document.createElement("div");n.style.padding="0 16px",a.dataChannel&&a.dataChannel.addEventListener("message",(e=>{const t=JSON.parse(e.data).message;if(t){const e=H(t);e.style.color="grey",n.prepend(e)}}));const i=(new r).element,o=new s("Send",(()=>{if(i.value){const e=H(i.value);if(n.prepend(e),a.dataChannel){const e=JSON.stringify({message:i.value});a.dataChannel.send(e)}i.value=""}})).element;return e.appendChild((()=>{const e=document.createElement("div");e.classList.add("oZzzSD5h");const t=document.createElement("div");return t.id="board",t.classList.add("uMa1QfRN"),setTimeout((()=>{const e=new z,t=Chessboard("board",{pieceTheme:"assets/{piece}.png",position:"start",draggable:!0,dropOffBoard:"trash",sparePieces:!1,onDragStart:function(t,n){return!e.isGameOver()&&!("w"===e.turn()&&-1!==n.search(/^b/)||"b"===e.turn()&&-1!==n.search(/^w/)||"white"===p.getState().game.orientation&&-1!==n.search(/^b/)||"black"===p.getState().game.orientation&&-1!==n.search(/^w/))&&void 0},onDrop:function(t,n){try{var s=e.move({from:t,to:n,promotion:"q"});if(a.dataChannel){const e=JSON.stringify({move:s});a.dataChannel.send(e)}}catch(e){console.error(e.message)}},onSnapEnd:function(){t.position(e.fen())}});t.orientation(p.getState().game.orientation),a.dataChannel&&a.dataChannel.addEventListener("message",(()=>{const n=JSON.parse(event.data).move;n&&(e.move(n),t.position(e.fen()))}))})),e.appendChild(t),e})()),t.appendChild(i),t.appendChild(o),e.appendChild(t),e.appendChild(n),e}})})()})();
//# sourceMappingURL=app.61af65814d4e5500c34c.js.map