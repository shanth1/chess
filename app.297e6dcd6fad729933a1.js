(()=>{"use strict";var e={972:(e,t,n)=>{n.r(t),n.d(t,{peerConfiguration:()=>s});const s={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478"},{urls:"stun:stun.services.mozilla.com"},{urls:"stun:stun.nextcloud.com:443"},{urls:"stun:numb.viagenie.ca"},{urls:"stun:stun.voip.blackberry.com:3478"},{urls:"stun:stun.voipbuster.com"},{urls:"stun:stun.voxgratia.org"},{urls:"stun:freestun.net:3479"},{urls:"stun:iphone-stun.strato-iphone.de:3478"},{urls:"stun:numb.viagenie.ca:3478"},{urls:"stun:s1.taraba.net:3478"},{urls:"stun:s2.taraba.net:3478"},{urls:"stun:stun.12connect.com:3478"},{urls:"stun:stun.12voip.com:3478"},{urls:"stun:stun.1und1.de:3478"},{urls:"stun:stun.2talk.co.nz:3478"},{urls:"stun:stun.2talk.com:3478"},{urls:"stun:stun.3clogic.com:3478"},{urls:"stun:stun.3cx.com:3478"},{urls:"stun:stun.a-mm.tv:3478"},{urls:"stun:stun.aa.net.uk:3478"},{urls:"stun:stun.acrobits.cz:3478"},{urls:"stun:stun.actionvoip.com:3478"},{urls:"stun:stun.advfn.com:3478"},{urls:"stun:stun.aeta-audio.com:3478"},{urls:"stun:stun.aeta.com:3478"},{urls:"stun:stun.alltel.com.au:3478"},{urls:"stun:stun.altar.com.pl:3478"},{urls:"stun:stun.annatel.net:3478"},{urls:"stun:stun.antisip.com:3478"},{urls:"stun:stun.arbuz.ru:3478"},{urls:"stun:stun.avigora.com:3478"},{urls:"stun:stun.avigora.fr:3478"},{urls:"stun:stun.awa-shima.com:3478"},{urls:"stun:stun.awt.be:3478"},{urls:"stun:stun.b2b2c.ca:3478"}]}}},t={};function n(s){var r=t[s];if(void 0!==r)return r.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,n),o.exports}n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{const e=class{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._element=document.createElement(e);for(const[e,n]of Object.entries(t))this._element.setAttribute(e,n)}get element(){return this._element}subscribe(e,t){e.subscribe(t),t()}},t=class extends e{constructor(e){super("div"),this._element.innerText=e,this._element.classList.add("header")}updateText(e){this._element.innerText=e}},s=class extends e{constructor(e,t){super("button"),this._element.innerText=e,this._element.classList.add("button"),this._element.onclick=t}},r=class extends e{constructor(){super("input"),this._element.classList.add("X6UxfUUG")}},o=new class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"page";!(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&console.log("url routing is not available now"),this.pageId=e,window.addEventListener("hashchange",(e=>{this._resolve()})),window.addEventListener("DOMContentLoaded",(()=>{this._resolve()}))}initRoutes(e){this._routes=e}initPageContainer(e){this._pageContainer=e,this._pageContainer.id="page-container"}_activeClassResolver(e,t){window.addEventListener(e,(()=>{""===location.hash?t("#"):t(location.hash)}))}updateActiveClass(e){this._activeClassResolver("hashchange",e),this._activeClassResolver("DOMContentLoaded",e)}navigate(e){location.hash=e}isActive(e){return!location.hash&&"#"===e||location.hash===e}_updatePage(e){this._pageContainer.innerHTML="",this._pageContainer.appendChild(e)}_resolve(){if(""===location.hash){const e=this._routes["/"];return void(e&&this._updatePage(e()))}const e=this._routes[location.hash.replace("#","/")];e?this._updatePage(e()):this._pageContainer.innerHTML="404 | Not Found"}},{peerConfiguration:a}=n(972),i=new class{constructor(e){this.peerConfiguration=e}initPeerConnection(){const e=JSON.parse(localStorage.getItem("chess-state"));e?.connection&&this.peerConfiguration.iceServers.push(...e.connection.turn),this.peer=new RTCPeerConnection(this.peerConfiguration)}initLogger(e){const t=(t,n)=>{const s=document.createElement("div");switch(s.style.paddingBottom="5px",n){case"ok":t&&(s.style.color="green");break;case"error":s.style.color="red";break;case"state":s.style.color="orange"}s.innerText=t,e.prepend(s)};this.peer.onconnectionstatechange=e=>{const n=`[state changed]: ${this.peer.iceConnectionState}`;t(n,"state")},this.peer.onicecandidateerror=e=>{t(e.type,"error")},this.peer.onicecandidate=e=>{const n=e.candidate?.candidate;t(n,"ok")}}getLocalDescription(){return JSON.stringify(this.peer.localDescription)}onIceCandidate(e){this.peer.addEventListener("icecandidate",(()=>{e()}))}setRemoteDescription(e){this.peer.setRemoteDescription(JSON.parse(e))}async createOffer(){try{const e=await this.peer.createOffer();this.peer.setLocalDescription(e)}catch(e){console.error(e)}}async createAnswer(){try{const e=await this.peer.createAnswer();this.peer.setLocalDescription(e)}catch(e){console.error(e)}}onOpen(e,t){switch(e){case"alice":this.peer.ondatachannel=e=>{console.log("on data channel",e),this.dataChannel=e.channel,this.dataChannel.onopen=t};break;case"bob":this.dataChannel=this.peer.createDataChannel("channel-name"),this.dataChannel.onopen=t;break;default:console.error("unknown role")}}}(a),c="SET_TURN_SERVERS",l="chess-state",u=new class{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._reducers=e,this._middlewares=t,this._isLocalStorageConnected=n;const s=JSON.parse(localStorage.getItem(l));this._isLocalStorageConnected&&s?this._state=s:this._state=this._reduce(),this._listeners=[],this._initMiddlewares()}_initMiddlewares(){var e=this;const t={getState:this.getState.bind(this),dispatch:function(t){for(var n=arguments.length,s=new Array(n>1?n-1:0),r=1;r<n;r++)s[r-1]=arguments[r];return e.dispatch(t,...s)}},n=this._middlewares.map((e=>e(t)));this.dispatch=n.reduce(((e,t)=>t(e)),this.dispatch.bind(this))}_reduce(e,t){return Object.keys(this._reducers).reduce(((n,s)=>(n[s]=this._reducers[s](e&&e[s],t),n)),{})}getState(){return this._state}dispatch(e){this._state=this._reduce(this._state,e),this._isLocalStorageConnected&&localStorage.setItem(l,JSON.stringify(this._state)),this._listeners.forEach((e=>e()))}subscribe(e){return this._listeners.push(e),()=>{this._listeners=this._listeners.filter((t=>t!==e))}}}({profile:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{username:"user",avatar:""},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("SET_USERNAME"===t.type)return{...e,text:t.payload.username}},connection:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{stun:[],turn:[]},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.type===c?{...e,turn:t.payload.data}:e}},[e=>t=>n=>{n.isFetch?fetch(n.payload.url).then((e=>e.json())).then((t=>{console.log("success response:",t);const s={type:n.type,payload:{data:t}};e.dispatch(s)})).catch((t=>{console.log("error on fetch:",t),e.dispatch({FETCH_ERROR:"FETCH_ERROR",payload:{error:t}})})):t(n)}]),d=function(n){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const r=new e("div").element;r.classList.add("j2362cLf");const o=new t(n);return r.appendChild(o.element),s.forEach((e=>r.appendChild(e))),r},h=e=>{const t=document.createElement("div");return t.innerText=`[${(new Date).getHours()}:${(new Date).getMinutes()}]: ${e}`,t.style.fontSize="24px",t};window.addEventListener("load",(()=>{(async()=>{if(navigator.serviceWorker)try{const e=await navigator.serviceWorker.register("./sw.js");console.log("SW register success",e)}catch(e){console.error("SW register failed:",e)}})()}));const p=document.getElementById("root");o.initPageContainer(p),o.initRoutes({"/":()=>{const e=document.createElement("div"),t=new s("p2p",(()=>{o.navigate("connect")})).element,n=new s("Engine").element;n.disabled=!0;const r=new s("Offline").element;r.disabled=!0;const a=[t,r,n];return e.appendChild(d("Menu",a)),e},"/alice":()=>{const e=document.createElement("div");e.style.padding="20px";const t=(()=>{const e=document.createElement("div");return e.style.padding="8px",e.style.fontSize="22px",e.innerText="Статус: ожидаем offer",e})(),n=document.createElement("div");i.initPeerConnection(),i.initLogger(n),i.onIceCandidate=()=>{t.innerText="Статус: создан answer"};const r=new s("Paste",(()=>{navigator.clipboard.readText().then((e=>{i.onIceCandidate((()=>t.innerText="Статус: создан answer")),i.setRemoteDescription(e),i.onOpen("alice",(()=>{o.navigate("game")})),i.createAnswer()})).catch(console.error)})).element;r.style.marginRight="8px";const a=new s("Copy",(()=>{const e=i.getLocalDescription();e&&navigator.clipboard.writeText(e).then((()=>{t.innerText="Статус: скопировано, ждем открытия канала"})).catch(console.error)})).element;return e.appendChild(t),e.appendChild(r),e.appendChild(a),e.appendChild(n),e},"/bob":()=>{const e=document.createElement("div");e.style.padding="20px";const t=(()=>{const e=document.createElement("div");return e.style.padding="8px",e.style.fontSize="22px",e.innerText="Статус:",e})(),n=document.createElement("div");i.initPeerConnection(),(e=>{i.onOpen("bob",(()=>{o.navigate("game")})),i.onIceCandidate((()=>{e.innerText="Статус: создан offer"}))})(t),i.initLogger(n),i.createOffer();const r=new s("Copy",(()=>{const e=i.getLocalDescription();e&&navigator.clipboard.writeText(e).then((()=>{t.innerText="Статус: скопировано, ожидаем answer"})).catch(console.error)})).element;r.style.marginRight="8px";const a=new s("Paste",(()=>{navigator.clipboard.readText().then((e=>{i.setRemoteDescription(e)})).catch(console.error)})).element;return e.appendChild(t),e.appendChild(r),e.appendChild(a),e.appendChild(n),e},"/connect":()=>{const t=document.createElement("div"),n=new s("Bob",(()=>{o.navigate("bob")})).element,r=new s("Alice",(()=>{o.navigate("alice")})).element,a=new s("Past TURN",(()=>{navigator.clipboard.readText().then((e=>{u.dispatch({isFetch:!0,type:c,payload:{url:e}})})).catch(console.error)})).element,i=new s("←",(()=>{o.navigate("")})).element;i.style.marginTop="20px";const l=[n,r,a,i],h=new e("div");return h.element.style.display="flex",h.element.style.justifyContent="center",h.subscribe(u,(()=>{localStorage.getItem("chess-state")?(h.element.innerText="turn is connected",h.element.style.color="green"):(h.element.innerText="turn is not connected",h.element.style.color="red")})),t.appendChild(d("Choose the role",l)),t.appendChild(h.element),t},"/game":()=>{const e=document.createElement("div"),t=document.createElement("form");t.style.display="flex",t.style.justifyContent="center",t.style.padding="20px",t.onsubmit=e=>e.preventDefault();const n=document.createElement("div");n.style.padding="0 16px",i.dataChannel&&(i.dataChannel.onmessage=e=>{const t=h(e.data);t.style.color="grey",n.prepend(t)});const o=(new r).element,a=new s("Send",(()=>{if(o.value){const e=h(o.value);n.prepend(e),i.dataChannel&&i.dataChannel.send(o.value),o.value=""}})).element;return t.appendChild(o),t.appendChild(a),e.appendChild(t),e.appendChild(n),e}})})()})();
//# sourceMappingURL=app.297e6dcd6fad729933a1.js.map